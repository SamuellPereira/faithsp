<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa faith SP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="icon" type="image/png" href="Captura de tela 2025-08-26 080640.png">
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
    body { display: flex; flex-direction: column; height: 100vh; background-color: #1d1f20; }
    header {
      background: rgba(0,0,0,0.6);
      color: #f5f5f5;
      padding: 12px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    /* FORM */
    .form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      justify-content: center;
    }
    .form input, .form button, .form select {
      flex: 1 1 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      border: none;
      background: #3a3a3a;
      color: #f0f0f0;
    }
    .form button {
      background: #444;
      color: #fff;
      cursor: pointer;
      touch-action: manipulation;
    }
    .form button:active { background: #222; }
    .form button:hover { background: #333; }

    /* MAPA */
    #map { flex: 1; width: 100%; }

    /* LISTA DE USUÁRIOS */
    #listaUsuarios {
      max-height: 220px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px;
      border-radius: 12px;
      background: rgba(50,50,50,0.6);
    }
    #listaUsuarios b {
      display: block;
      font-size: 18px;
      margin-bottom: 8px;
      color: #f5f5f5;
      text-align: center;
    }
    #listaUsuarios div {
      background: #2c2c2c;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 15px;
      color: #f0f0f0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Responsividade */
    @media (min-width: 600px) {
      .form input, .form button, .form select {
        flex: 1 1 45%;
      }
    }
  </style>
</head>
<body>

<header><img src="Captura de tela 2025-08-26 080640.png" alt="" height="50px" width="50px"></header>

<div class="form">
  <input type="text" id="nome" placeholder="Digite seu nome">
  <input type="text" id="cidade" placeholder="Digite sua cidade (ex: Embu das Artes)">
  <select id="estado">
    <option value="">Selecione seu estado</option>
    <option value="AC">Acre (AC)</option>
    <option value="AL">Alagoas (AL)</option>
    <option value="AP">Amapá (AP)</option>
    <option value="AM">Amazonas (AM)</option>
    <option value="BA">Bahia (BA)</option>
    <option value="CE">Ceará (CE)</option>
    <option value="DF">Distrito Federal (DF)</option>
    <option value="ES">Espírito Santo (ES)</option>
    <option value="GO">Goiás (GO)</option>
    <option value="MA">Maranhão (MA)</option>
    <option value="MT">Mato Grosso (MT)</option>
    <option value="MS">Mato Grosso do Sul (MS)</option>
    <option value="MG">Minas Gerais (MG)</option>
    <option value="PA">Pará (PA)</option>
    <option value="PB">Paraíba (PB)</option>
    <option value="PR">Paraná (PR)</option>
    <option value="PE">Pernambuco (PE)</option>
    <option value="PI">Piauí (PI)</option>
    <option value="RJ">Rio de Janeiro (RJ)</option>
    <option value="RN">Rio Grande do Norte (RN)</option>
    <option value="RS">Rio Grande do Sul (RS)</option>
    <option value="RO">Rondônia (RO)</option>
    <option value="RR">Roraima (RR)</option>
    <option value="SC">Santa Catarina (SC)</option>
    <option value="SP">São Paulo (SP)</option>
    <option value="SE">Sergipe (SE)</option>
    <option value="TO">Tocantins (TO)</option>
  </select>
  <button id="btnAdicionar">Adicionar</button>
</div>

<div class="form">
  <select id="filtroEstado" onchange="filtrarUsuarios()">
    <option value="">-- Filtrar por Estado --</option>
    <option value="AC">Acre (AC)</option>
    <option value="AL">Alagoas (AL)</option>
    <option value="AP">Amapá (AP)</option>
    <option value="AM">Amazonas (AM)</option>
    <option value="BA">Bahia (BA)</option>
    <option value="CE">Ceará (CE)</option>
    <option value="DF">Distrito Federal (DF)</option>
    <option value="ES">Espírito Santo (ES)</option>
    <option value="GO">Goiás (GO)</option>
    <option value="MA">Maranhão (MA)</option>
    <option value="MT">Mato Grosso (MT)</option>
    <option value="MS">Mato Grosso do Sul (MS)</option>
    <option value="MG">Minas Gerais (MG)</option>
    <option value="PA">Pará (PA)</option>
    <option value="PB">Paraíba (PB)</option>
    <option value="PR">Paraná (PR)</option>
    <option value="PE">Pernambuco (PE)</option>
    <option value="PI">Piauí (PI)</option>
    <option value="RJ">Rio de Janeiro (RJ)</option>
    <option value="RN">Rio Grande do Norte (RN)</option>
    <option value="RS">Rio Grande do Sul (RS)</option>
    <option value="RO">Rondônia (RO)</option>
    <option value="RR">Roraima (RR)</option>
    <option value="SC">Santa Catarina (SC)</option>
    <option value="SP">São Paulo (SP)</option>
    <option value="SE">Sergipe (SE)</option>
    <option value="TO">Tocantins (TO)</option>
  </select>
</div>

<div class="form">
  <input type="text" id="cidadeBusca" placeholder="Procurar cidade para encontro (ex: Barueri)">
  <button id="btnBuscarCidade">Calcular Distâncias</button>
</div>

<div id="map"></div>
<div id="listaUsuarios"><b>Membros Faith Sp:</b></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
  const supabaseUrl = "https://fuztuqibppbzuyqmetxm.supabase.co"; 
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1enR1cWlicHBienV5cW1ldHhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzIxNDAsImV4cCI6MjA3MTcwODE0MH0.cpDxMS35dnW3NTXA8iunLVoW3rXYRfKDX0vbV1eX-eI"; 
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

   var map = L.map('map').setView([-23.55, -46.63], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let usuariosCache = [];
  let marcadorBusca = null;

  function calcularDistancia(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return (R * c).toFixed(1);
  }

  async function adicionarMarcador() {
    var nome = document.getElementById("nome").value.trim();
    var cidade = document.getElementById("cidade").value.trim();
    var estado = document.getElementById("estado").value.trim();
    if(!nome || !cidade || !estado) { alert("Preencha nome, cidade e estado!"); return; }

    try {
      let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${cidade},${estado},Brasil`);
      let data = await response.json();

      if(data.length > 0){
        let lat = parseFloat(data[0].lat);
        let lon = parseFloat(data[0].lon);

        let { error } = await supabaseClient.from("usuarios_mapa")
          .insert([{ nome, cidade, estado, lat, lon }]);

        if(error){ console.error(error); alert("Erro ao salvar no banco!"); }
        else {
          document.getElementById("nome").value = "";
          document.getElementById("cidade").value = "";
          document.getElementById("estado").value = "";
          carregarUsuarios(); 
        }
      } else { alert("Cidade não encontrada!"); }
    } catch(err) {
      console.error("Erro:", err);
      alert("Erro de conexão. Tente novamente.");
    }
  }

  async function carregarUsuarios(estadoFiltro = ""){
    let query = supabaseClient.from("usuarios_mapa").select("*");
    if(estadoFiltro) query = query.eq("estado", estadoFiltro);

    let { data, error } = await query;
    if(error){ console.error(error); return; }

    usuariosCache = data;

    const listaDiv = document.getElementById("listaUsuarios");
    listaDiv.innerHTML = "<b>Membros Faith Sp:</b>";

    // remove marcadores antigos (mas mantém busca)
    map.eachLayer((layer) => {
      if(layer instanceof L.Marker && layer !== marcadorBusca) map.removeLayer(layer); 
    });

    data.forEach(u => {
      L.marker([u.lat, u.lon])
        .addTo(map)
        .bindPopup(`<b>${u.nome}</b><br>${u.cidade}/${u.estado}`);
      
      const item = document.createElement("div");
      item.textContent = `${u.nome} - ${u.cidade} - ${u.estado}`;
      listaDiv.appendChild(item);
    });
  }

  function filtrarUsuarios(){
    let estado = document.getElementById("filtroEstado").value;
    carregarUsuarios(estado);
  }

  carregarUsuarios();

  document.getElementById("btnAdicionar").addEventListener("click", (e) => {
    e.preventDefault();
    adicionarMarcador();
  });

  document.getElementById("btnBuscarCidade").addEventListener("click", async (e) => {
    e.preventDefault();
    const cidadeBusca = document.getElementById("cidadeBusca").value.trim();
    if(!cidadeBusca){ alert("Digite uma cidade!"); return; }

    try {
      let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${cidadeBusca},Brasil`);
      let data = await response.json();

      if(data.length > 0){
        let latBusca = parseFloat(data[0].lat);
        let lonBusca = parseFloat(data[0].lon);

        const listaDiv = document.getElementById("listaUsuarios");
        listaDiv.innerHTML = `<b>Membros Faith Sp: (distância até ${cidadeBusca}):</b>`;

        usuariosCache.forEach(u => {
          let dist = calcularDistancia(latBusca, lonBusca, u.lat, u.lon);
          const item = document.createElement("div");
          item.textContent = `${u.nome} - ${u.cidade} - ${u.estado} → ${dist} km`;
          listaDiv.appendChild(item);
        });

        if(marcadorBusca) map.removeLayer(marcadorBusca);

        marcadorBusca = L.marker([latBusca, lonBusca], {icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149059.png',
          iconSize: [30,30]
        })})
        .addTo(map)
        .bindPopup(`<b>${cidadeBusca}</b>`).openPopup();

        map.setView([latBusca, lonBusca], 10);

      } else { alert("Cidade não encontrada!"); }
    } catch(err) {
      console.error(err);
      alert("Erro ao buscar cidade.");
    }
  });
</script>
</body>
</html>
